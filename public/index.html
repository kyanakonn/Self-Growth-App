<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Self Growth App</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;background:#f8fafc;color:#0f172a;font-family:system-ui}
.screen{display:none;padding:16px}
.screen.active{display:block}
button{width:100%;padding:14px;margin-top:8px;border:none;border-radius:14px;background:#fff;box-shadow:0 4px 12px rgba(0,0,0,.12)}
.card{background:#fff;border-radius:18px;padding:16px;margin-top:14px;box-shadow:0 6px 20px rgba(0,0,0,.1)}
.exp-bar{height:16px;background:#e5e7eb;border-radius:10px;overflow:hidden}
.exp-fill{height:100%;background:#0f172a;width:0%;transition:width .8s}
.timer-full{position:fixed;inset:0;background:#fff;display:none;align-items:center;justify-content:center;flex-direction:column;font-size:72px;z-index:999}
.timer-btns{display:flex;gap:12px;margin-top:24px}
</style>
</head>

<body>

<div id="start" class="screen active">
<h1>ğŸ“š Self Growth App</h1>
<button onclick="newStart()">æ–°è¦ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
<input id="codeInput" placeholder="å¼•ãç¶™ãã‚³ãƒ¼ãƒ‰">
<button onclick="login()">å¼•ãç¶™ã</button>
<div id="startCode"></div>
</div>

<div id="home" class="screen">
<button onclick="goProfile()">ğŸ‘¤ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</button>

<div class="card">
Lv <span id="level"></span>
<div class="exp-bar"><div id="expFill" class="exp-fill"></div></div>
</div>

<div class="card">
<h3>âœï¸ æ‰‹å‹•è¨˜éŒ²</h3>
<select id="manualSubject"></select>
<input id="h" type="number" placeholder="æ™‚é–“">
<input id="m" type="number" placeholder="åˆ†">
<button onclick="manualSave()">ä¿å­˜</button>
</div>

<div class="card">
<h3>ç§‘ç›®è¿½åŠ </h3>
<input id="newSub">
<button onclick="addSubject()">è¿½åŠ </button>
</div>

<div class="card">
<h3>ğŸ“Š å‹‰å¼·ã‚°ãƒ©ãƒ•</h3>
<div style="display:flex;gap:6px">
<button onclick="changeMode('day')">æ—¥</button>
<button onclick="changeMode('week')">é€±</button>
<button onclick="changeMode('month')">æœˆ</button>
</div>
<canvas id="chart"></canvas>
</div>

<button onclick="startTimer()">â± ã‚¿ã‚¤ãƒãƒ¼</button>
</div>

<div id="profile" class="screen">
<button onclick="goHome()">â† æˆ»ã‚‹</button>
<div class="card">
<p>ãƒ¬ãƒ™ãƒ«: <span id="pLevel"></span></p>
<p>ç·EXP: <span id="pExp"></span></p>
<p>åˆè¨ˆè¨˜éŒ²æ™‚é–“: <span id="pTime"></span> æ™‚é–“</p>
<p>å¼•ãç¶™ãã‚³ãƒ¼ãƒ‰: <span id="pCode"></span></p>
</div>
</div>

<div id="timerFull" class="timer-full">
<div id="timerText">0:00</div>
<div class="timer-btns">
<button onclick="stopTimer()">STOP</button>
<button onclick="saveTimer()">ä¿å­˜</button>
</div>
</div>

<script>
/* ===== ãƒ‡ãƒ¼ã‚¿ ===== */
let userId = localStorage.getItem("userId");
let subjects = JSON.parse(localStorage.getItem("subjects")) || ["è‹±èª","ä¸–ç•Œå²"];
let colors = JSON.parse(localStorage.getItem("colors")) || {};
let logs = JSON.parse(localStorage.getItem("logs")) || [];

let profile = JSON.parse(localStorage.getItem("profile")) || {
 level:1,
 exp:0,
 totalMin:0,
 streak:0,
 lastDate:null
};

/* ===== åˆæœŸåŒ– ===== */
if(userId){
 switchScreen("home");
 init();
}

function newStart(){
 userId = "USER-"+Date.now().toString(36);
 localStorage.setItem("userId",userId);
 startCode.textContent = "å¼•ãç¶™ãã‚³ãƒ¼ãƒ‰: "+userId;
 saveAll();
 switchScreen("home");
 init();
}

function login(){
 userId = codeInput.value;
 localStorage.setItem("userId",userId);
 switchScreen("home");
 init();
}

function init(){
 renderSubjects();
 initChart();
 updateProfile();
 drawChart();
}

function saveAll(){
 localStorage.setItem("subjects",JSON.stringify(subjects));
 localStorage.setItem("colors",JSON.stringify(colors));
 localStorage.setItem("logs",JSON.stringify(logs));
 localStorage.setItem("profile",JSON.stringify(profile));
}

/* ===== UI ===== */
function switchScreen(id){
 document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
 document.getElementById(id).classList.add("active");
}

function goProfile(){
 pLevel.textContent = profile.level;
 pExp.textContent = profile.exp;
 pTime.textContent = (profile.totalMin/60).toFixed(1);
 pCode.textContent = userId;
 switchScreen("profile");
}
function goHome(){switchScreen("home")}

/* ===== ç§‘ç›® ===== */
function renderSubjects(){
 manualSubject.innerHTML="";
 subjects.forEach(s=>{
  if(!colors[s]){
   colors[s]=`hsl(${Math.random()*360},70%,50%)`;
  }
  const o=document.createElement("option");
  o.textContent=s;
  manualSubject.appendChild(o);
 });
 saveAll();
}

function addSubject(){
 if(!newSub.value) return;
 subjects.push(newSub.value);
 newSub.value="";
 renderSubjects();
 drawChart();
}

/* ===== è¨˜éŒ²ï¼ˆEXPè¨ˆç®—æ”¹ä¿®æ¸ˆã¿ï¼‰ ===== */
function manualSave(){
 const min=(+h.value||0)*60+(+m.value||0);
 if(min<=0) return;
 addLog(manualSubject.value,min);
}

function addLog(sub,min){
 const today = new Date().toISOString().slice(0,10);

 // é€£ç¶šè¨˜éŒ²åˆ¤å®š
 if(profile.lastDate){
  const diff = (new Date(today) - new Date(profile.lastDate)) / 86400000;
  if(diff === 1){
   profile.streak++;
  }else if(diff > 1){
   profile.streak = 1;
  }
 }else{
  profile.streak = 1;
 }
 profile.lastDate = today;

 // EXPè¨ˆç®—
 let baseExp = min;
 const streakBonus = Math.min(1 + profile.streak * 0.03, 2);
 let gainedExp = baseExp * streakBonus;

 // 100æ™‚é–“ãƒœãƒ¼ãƒŠã‚¹
 const before100 = Math.floor(profile.totalMin / 6000);
 profile.totalMin += min;
 const after100 = Math.floor(profile.totalMin / 6000);
 if(after100 > before100){
  gainedExp += 2000;
 }

 profile.exp += Math.floor(gainedExp);
 logs.push({date:today,sub,min});

 checkLevel();
 saveAll();
 updateProfile();
 drawChart();
}

/* ===== ãƒ¬ãƒ™ãƒ«è¨ˆç®—ï¼ˆ3000æ™‚é–“â‰’Lv100ï¼‰ ===== */
function checkLevel(){
 while(true){
  const need = Math.floor(30 * Math.pow(profile.level, 1.9));
  if(profile.exp < need) break;
  profile.exp -= need;
  profile.level++;
 }
}

function updateProfile(){
 level.textContent = profile.level;
 const need = 30 * Math.pow(profile.level, 1.9);
 expFill.style.width = Math.min(profile.exp / need * 100, 100) + "%";
}

/* ===== ã‚°ãƒ©ãƒ• ===== */
let chart, mode="day";

function changeMode(m){mode=m; drawChart();}

function initChart(){
 chart=new Chart(document.getElementById("chart"),{
  type:"bar",
  data:{labels:[],datasets:[]},
  options:{responsive:true}
 });
}

function drawChart(){
 const map={};
 logs.forEach(l=>{
  const d=new Date(l.date);
  let key = mode==="day"?l.date : mode==="week"?d.getDay() : d.getDate();
  map[key]=map[key]||{total:0};
  map[key][l.sub]=(map[key][l.sub]||0)+l.min/60;
  map[key].total+=l.min/60;
 });

 const keys=Object.keys(map).sort();
 chart.data.labels=keys;

 chart.data.datasets=[
  ...subjects.map(s=>({
   label:s,
   backgroundColor:colors[s],
   data:keys.map(k=>map[k][s]||0)
  })),
  {
   label:"åˆè¨ˆ",
   backgroundColor:"#94a3b8",
   data:keys.map(k=>map[k].total)
  }
 ];
 chart.update();
}

/* ===== ã‚¿ã‚¤ãƒãƒ¼ ===== */
let sec=0,timerInt=null;

function startTimer(){
 if(timerInt) return;
 sec=0;
 timerText.textContent="0:00";
 timerFull.style.display="flex";
 timerInt=setInterval(()=>{
  sec++;
  timerText.textContent=
   Math.floor(sec/60)+":"+String(sec%60).padStart(2,"0");
 },1000);
}

function stopTimer(){
 clearInterval(timerInt);
 timerInt=null;
}

function saveTimer(){
 stopTimer();
 timerFull.style.display="none";
 addLog(manualSubject.value,Math.floor(sec/60));
 sec=0;
}
</script>
</body>
</html>
