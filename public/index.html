<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Self Growth App</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{margin:0;background:#f8fafc;color:#0f172a;font-family:system-ui}
.screen{display:none;padding:16px}
.screen.active{display:block}
button{width:100%;padding:14px;margin-top:8px;border:none;border-radius:14px;background:#fff;box-shadow:0 4px 12px rgba(0,0,0,.12)}
.card{background:#fff;border-radius:18px;padding:16px;margin-top:14px;box-shadow:0 6px 20px rgba(0,0,0,.1)}
.exp-bar{height:16px;background:#e5e7eb;border-radius:10px;overflow:hidden}
.exp-fill{height:100%;background:#0f172a;width:0%;transition:1s}
.timer{font-size:40px;text-align:center}
.timer-full{position:fixed;inset:0;background:#fff;display:none;align-items:center;justify-content:center;font-size:72px;z-index:999}
.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:8px}
.day{padding:8px;text-align:center;border-radius:8px;background:#e5e7eb}
</style>
</head>
<body>

<!-- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
<div id="start" class="screen active">
  <h1>ğŸ“š Self Growth App</h1>
  <button onclick="newStart()">æ–°è¦ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
</div>

<!-- ãƒ›ãƒ¼ãƒ ç”»é¢ -->
<div id="home" class="screen">

  <!-- ãƒ¬ãƒ™ãƒ«ãƒ»EXPãƒ»ã‚¹ãƒˆãƒªãƒ¼ã‚¯ãƒ»é€±é–“æ®‹ã‚Š -->
  <div class="card">
    Lv <span id="level"></span>
    <div class="exp-bar"><div id="expFill" class="exp-fill"></div></div>
    ğŸ”¥ <span id="streak"></span>æ—¥  
    â³ é€±é–“æ®‹ã‚Š <span id="weeklyRemain"></span>
  </div>

  <!-- é€±é–“ç›®æ¨™è¨­å®š -->
  <div class="card">
    <h3>é€±é–“ç›®æ¨™ï¼ˆæ™‚é–“ï¼‰</h3>
    <input id="weeklyInput" type="number" placeholder="ä¾‹: 20">
    <button onclick="updateWeekly()">è¨­å®š</button>
  </div>

  <!-- æ‰‹å‹•è¨˜éŒ² -->
  <div class="card">
    <h3>âœï¸ æ‰‹å‹•è¨˜éŒ²</h3>
    <select id="manualSubject"></select>
    <input id="manualHour" type="number" placeholder="æ™‚é–“" min="0">
    <input id="manualMin" type="number" placeholder="åˆ†" min="0" max="59">
    <button onclick="saveManual()">è¨˜éŒ²ã™ã‚‹</button>
  </div>

  <!-- AIå­¦ç¿’åˆ†æ -->
  <div class="card">
    <h3>ğŸ§  AIå­¦ç¿’åˆ†æ</h3>
    <select id="targetUniv">
      <option value="waseda_sho">æ—©ç¨²ç”° å•†</option>
    </select>
    <button onclick="runAI()">åˆ†æã™ã‚‹</button>
    <div id="aiResult"></div>
  </div>

  <!-- æ¨¡è©¦æˆç¸¾ -->
  <div class="card">
    <h3>ğŸ“Š æ¨¡è©¦æˆç¸¾å…¥åŠ›</h3>
    è‹±èª <input id="mockEng" type="number">
    ä¸–ç•Œå² <input id="mockWorld" type="number">
    <button onclick="saveMock()">ä¿å­˜ & åˆ†æ</button>
  </div>

  <!-- ç§‘ç›®è¿½åŠ ãƒ»å‰Šé™¤ -->
  <div class="card">
    <h3>ç§‘ç›®ç®¡ç†</h3>
    <input id="newSubject" type="text" placeholder="æ–°ã—ã„ç§‘ç›®å">
    <button onclick="addSubject()">ç§‘ç›®è¿½åŠ </button>
    <ul id="subjectList"></ul>
  </div>

  <!-- ã‚¿ã‚¤ãƒãƒ¼ -->
  <div class="card">
    <h3>ã‚¿ã‚¤ãƒãƒ¼</h3>
    <select id="timerSubject"></select>
    <button id="start-btn">START</button>
    <button id="stop-btn" disabled>STOP</button>
    <button id="save-btn" style="display:none">ä¿å­˜</button>
  </div>

  <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
  <div class="card">
    <h3>ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h3>
    <div id="calendar" class="calendar"></div>
  </div>

  <!-- ç§‘ç›®åˆ¥ã‚°ãƒ©ãƒ• -->
  <div class="card">
    <h3>ğŸ“Š ç§‘ç›®åˆ¥ã‚°ãƒ©ãƒ•</h3>
    <select onchange="changeGraph(this.value)">
      <option value="7">7æ—¥</option>
      <option value="week">é€±</option>
      <option value="month">æœˆ</option>
    </select>
    <canvas id="chart"></canvas>
  </div>

</div>

<div id="timerFull" class="timer-full">0:00</div>

<script>
let subjects = [];
let timerRunning = false;
let elapsedSeconds = 0;
let timerInterval = null;
let currentSubject = null;

const timerSubject = document.getElementById('timerSubject');
const timerFull = document.getElementById('timerFull');
const subjectList = document.getElementById('subjectList');

// ===== åˆæœŸåŒ– =====
async function init(){
  await loadSubjects();
  renderCalendar();
}
init();

// ===== æ–°è¦ã‚¹ã‚¿ãƒ¼ãƒˆ =====
function newStart(){
  document.getElementById('start').classList.remove('active');
  document.getElementById('home').classList.add('active');
}

// ===== ç§‘ç›®è¿½åŠ  =====
async function addSubject(){
  const name = document.getElementById('newSubject').value.trim();
  if(!name) return alert("ç§‘ç›®åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

  const res = await fetch('/api/subject',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({userId:'demo-user', name})
  });
  if(res.ok){
    document.getElementById('newSubject').value='';
    await loadSubjects();
  }
}

// ===== ç§‘ç›®å‰Šé™¤ =====
async function deleteSubject(id){
  subjects = subjects.filter(s=>s.id!==id);
  await renderSubjectList();
  await renderSubjectSelect();
}

// ===== ç§‘ç›®ãƒ­ãƒ¼ãƒ‰ =====
async function loadSubjects(){
  const res = await fetch('/api/subjects/demo-user');
  subjects = await res.json();
  await renderSubjectList();
  await renderSubjectSelect();
}

async function renderSubjectList(){
  subjectList.innerHTML='';
  subjects.forEach(s=>{
    const li=document.createElement('li');
    li.textContent=s.name+' ';
    const del=document.createElement('button');
    del.textContent='å‰Šé™¤';
    del.onclick=()=>deleteSubject(s.id);
    li.appendChild(del);
    subjectList.appendChild(li);
  });
}

async function renderSubjectSelect(){
  const manual = document.getElementById('manualSubject');
  manual.innerHTML='';
  subjects.forEach(s=>{
    const o=document.createElement('option');
    o.value=s.id; o.textContent=s.name;
    manual.appendChild(o);
  });

  timerSubject.innerHTML='';
  subjects.forEach(s=>{
    const o=document.createElement('option');
    o.value=s.id; o.textContent=s.name;
    timerSubject.appendChild(o);
  });
}

// ===== ã‚¿ã‚¤ãƒãƒ¼ =====
document.getElementById('start-btn').addEventListener('click',()=>{
  if(timerRunning) return;
  const selected = timerSubject.value;
  if(!selected) return alert("ç§‘ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„");

  currentSubject=selected;
  timerRunning=true;
  elapsedSeconds=0;

  timerFull.style.display='flex';
  timerFull.textContent='0:00';
  timerFull.requestFullscreen?.();

  document.getElementById('start-btn').disabled=true;
  document.getElementById('stop-btn').disabled=false;

  timerInterval = setInterval(()=>{
    elapsedSeconds++;
    const min=Math.floor(elapsedSeconds/60);
    const sec=elapsedSeconds%60;
    timerFull.textContent=`${min}:${sec.toString().padStart(2,'0')}`;
  },1000);
});

document.getElementById('stop-btn').addEventListener('click',()=>{
  if(!timerRunning) return;
  clearInterval(timerInterval);
  timerRunning=false;

  document.getElementById('stop-btn').disabled=true;
  document.getElementById('save-btn').style.display='block';
});

document.getElementById('save-btn').addEventListener('click',async()=>{
  const minutes = Math.floor(elapsedSeconds/60);
  if(minutes<=0) return alert("1åˆ†ä»¥ä¸Šè¨ˆæ¸¬ã—ã¦ãã ã•ã„");

  await fetch('/api/log',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({userId:'demo-user', subjectId:currentSubject, minutes})
  });

  elapsedSeconds=0;
  timerFull.textContent='0:00';
  timerFull.style.display='none';
  document.getElementById('save-btn').style.display='none';
  document.getElementById('start-btn').disabled=false;

  alert("ä¿å­˜ã—ã¾ã—ãŸ");
});

// ===== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”» =====
function renderCalendar(){
  const calendar=document.getElementById('calendar');
  calendar.innerHTML='';
  for(let i=1;i<=30;i++){
    const d=document.createElement('div');
    d.className='day';
    d.textContent=i;
    calendar.appendChild(d);
  }
}
</script>
</body>
</html>
