<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Self Growth App</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{margin:0;background:#f8fafc;color:#0f172a;font-family:system-ui}
.screen{display:none;padding:16px}
.screen.active{display:block}
button{width:100%;padding:14px;margin-top:8px;border:none;border-radius:14px;background:#fff;box-shadow:0 4px 12px rgba(0,0,0,.12)}
.card{background:#fff;border-radius:18px;padding:16px;margin-top:14px;box-shadow:0 6px 20px rgba(0,0,0,.1)}
.exp-bar{height:16px;background:#e5e7eb;border-radius:10px;overflow:hidden;position:relative}
.exp-fill{height:100%;background:#0f172a;width:0%;transition:width 1s, transform 0.3s}
.exp-up{transform:scaleY(1.4)}
.timer{font-size:40px;text-align:center}
.timer-full{position:fixed;inset:0;background:#fff;display:none;align-items:center;justify-content:center;flex-direction:column;font-size:72px;z-index:999}
.timer-btns{margin-top:20px;width:80%;display:flex;justify-content:space-around}
.timer-btns button{width:30%;font-size:18px}
.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:8px}
.day{padding:8px;text-align:center;border-radius:8px;background:#e5e7eb}
.bonus{padding:16px;margin-top:16px;background:#fde68a;border-radius:18px;text-align:center;font-weight:bold;animation:flash 0.8s}
@keyframes flash{0%{transform:scale(1);background:#fde68a}50%{transform:scale(1.2);background:#facc15}100%{transform:scale(1);background:#fde68a}}
</style>
</head>
<body>

<div id="start" class="screen active">
  <h1>ğŸ“š Self Growth App</h1>
  <button onclick="newStart()">æ–°è¦ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
  <div style="margin-top:16px">
    <input id="codeInput" type="text" placeholder="å¼•ãç¶™ãã‚³ãƒ¼ãƒ‰">
    <button onclick="loginWithCode()">ãƒ­ã‚°ã‚¤ãƒ³</button>
  </div>
  <div id="showCode" style="margin-top:16px;color:#0f172a;font-weight:bold"></div>
</div>

<div id="home" class="screen">

  <!-- ãƒ¬ãƒ™ãƒ«ãƒ»EXPãƒ»ã‚¹ãƒˆãƒªãƒ¼ã‚¯ãƒ»é€±é–“æ®‹ã‚Š -->
  <div class="card">
    Lv <span id="level">1</span>
    <div class="exp-bar"><div id="expFill" class="exp-fill"></div></div>
    ğŸ”¥ <span id="streak">0</span>æ—¥  
    â³ é€±é–“æ®‹ã‚Š <span id="weeklyRemain">0</span>
  </div>

  <div id="bonusDiv" class="bonus" style="display:none">ğŸ‰ 100æ™‚é–“é”æˆãƒœãƒ¼ãƒŠã‚¹ï¼ğŸ‰</div>

  <!-- é€±é–“ç›®æ¨™è¨­å®š -->
  <div class="card">
    <h3>é€±é–“ç›®æ¨™ï¼ˆæ™‚é–“ï¼‰</h3>
    <input id="weeklyInput" type="number" placeholder="ä¾‹: 20">
    <button onclick="updateWeekly()">è¨­å®š</button>
  </div>

  <!-- æ‰‹å‹•è¨˜éŒ² -->
  <div class="card">
    <h3>âœï¸ æ‰‹å‹•è¨˜éŒ²</h3>
    <select id="manualSubject"></select>
    <input id="manualHour" type="number" placeholder="æ™‚é–“" min="0">
    <input id="manualMin" type="number" placeholder="åˆ†" min="0" max="59">
    <button onclick="saveManual()">è¨˜éŒ²ã™ã‚‹</button>
  </div>

  <!-- AIå­¦ç¿’åˆ†æ -->
  <div class="card">
    <h3>ğŸ§  AIå­¦ç¿’åˆ†æ</h3>
    <select id="targetUniv">
      <option value="waseda_sho">æ—©ç¨²ç”° å•†</option>
    </select>
    <button onclick="runAI()">åˆ†æã™ã‚‹</button>
    <div id="aiResult"></div>
  </div>

  <!-- æ¨¡è©¦æˆç¸¾ -->
  <div class="card">
    <h3>ğŸ“Š æ¨¡è©¦æˆç¸¾å…¥åŠ›</h3>
    è‹±èª <input id="mockEng" type="number">
    ä¸–ç•Œå² <input id="mockWorld" type="number">
    <button onclick="saveMock()">ä¿å­˜ & åˆ†æ</button>
  </div>

  <!-- ç§‘ç›®è¿½åŠ ãƒ»å‰Šé™¤ -->
  <div class="card">
    <h3>ç§‘ç›®ç®¡ç†</h3>
    <input id="newSubject" type="text" placeholder="æ–°ã—ã„ç§‘ç›®å">
    <button onclick="addSubject()">ç§‘ç›®è¿½åŠ </button>
    <ul id="subjectList"></ul>
  </div>

  <!-- ã‚¿ã‚¤ãƒãƒ¼ -->
  <div class="card">
    <h3>ã‚¿ã‚¤ãƒãƒ¼</h3>
    <select id="timerSubject"></select>
    <button id="start-btn">START</button>
    <button id="stop-btn" disabled>STOP</button>
    <button id="save-btn" style="display:none">ä¿å­˜</button>
  </div>

  <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
  <div class="card">
    <h3>ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h3>
    <div id="calendar" class="calendar"></div>
  </div>

  <!-- ç§‘ç›®åˆ¥ã‚°ãƒ©ãƒ• -->
  <div class="card">
    <h3>ğŸ“Š ç§‘ç›®åˆ¥ã‚°ãƒ©ãƒ•</h3>
    <select onchange="changeGraph(this.value)">
      <option value="7">7æ—¥</option>
      <option value="week">é€±</option>
      <option value="month">æœˆ</option>
    </select>
    <canvas id="chart"></canvas>
  </div>

</div>

<!-- å…¨ç”»é¢ã‚¿ã‚¤ãƒãƒ¼ -->
<div id="timerFull" class="timer-full">
  <div id="timerText">0:00</div>
  <div class="timer-btns">
    <button id="fullStartBtn">START</button>
    <button id="fullStopBtn" disabled>STOP</button>
    <button id="fullSaveBtn" style="display:none">ä¿å­˜</button>
  </div>
</div>

<script>
let subjects = [];
let timerRunning = false;
let elapsedSeconds = 0;
let timerInterval = null;
let currentSubject = null;
let userId = null;
let chart = null;

const timerSubject = document.getElementById('timerSubject');
const timerFull = document.getElementById('timerFull');
const timerText = document.getElementById('timerText');
const subjectList = document.getElementById('subjectList');
const expFill = document.getElementById('expFill');
const bonusDiv = document.getElementById('bonusDiv');
const showCode = document.getElementById('showCode');

// ===== åˆæœŸåŒ– =====
async function init(){
  if(userId) {
    await loadSubjects();
    renderCalendar();
    await updateProfileDisplay();
    initChart();
  }
}

// ===== æ–°è¦ã‚¹ã‚¿ãƒ¼ãƒˆ =====
function newStart(){
  userId = 'user-'+Date.now().toString(36);
  document.getElementById('start').classList.remove('active');
  document.getElementById('home').classList.add('active');
  showCode.textContent = 'å¼•ãç¶™ãã‚³ãƒ¼ãƒ‰: '+userId;
  init();
}

// ===== å¼•ãç¶™ããƒ­ã‚°ã‚¤ãƒ³ =====
function loginWithCode(){
  const code = document.getElementById('codeInput').value.trim();
  if(!code) return alert("ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  userId = code;
  document.getElementById('start').classList.remove('active');
  document.getElementById('home').classList.add('active');
  init();
}

// ===== ç§‘ç›®è¿½åŠ  =====
async function addSubject(){
  const name = document.getElementById('newSubject').value.trim();
  if(!name) return alert("ç§‘ç›®åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  // ç–‘ä¼¼API
  const id = 'subj-'+Date.now().toString(36);
  subjects.push({id,name});
  document.getElementById('newSubject').value='';
  await renderSubjectList();
  await renderSubjectSelect();
  updateChart();
}

// ===== ç§‘ç›®å‰Šé™¤ =====
async function deleteSubject(id){
  subjects = subjects.filter(s=>s.id!==id);
  await renderSubjectList();
  await renderSubjectSelect();
  updateChart();
}

// ===== ç§‘ç›®ãƒ­ãƒ¼ãƒ‰ =====
async function loadSubjects(){
  // ç–‘ä¼¼API åˆæœŸç§‘ç›®
  subjects = [{id:'eng',name:'è‹±èª'},{id:'world',name:'ä¸–ç•Œå²'}];
  await renderSubjectList();
  await renderSubjectSelect();
}

// ===== è¡¨ç¤º =====
async function renderSubjectList(){
  subjectList.innerHTML='';
  subjects.forEach(s=>{
    const li=document.createElement('li');
    li.textContent=s.name+' ';
    const del=document.createElement('button');
    del.textContent='å‰Šé™¤';
    del.onclick=()=>deleteSubject(s.id);
    li.appendChild(del);
    subjectList.appendChild(li);
  });
}

async function renderSubjectSelect(){
  const manual = document.getElementById('manualSubject');
  manual.innerHTML='';
  subjects.forEach(s=>{
    const o=document.createElement('option');
    o.value=s.id; o.textContent=s.name;
    manual.appendChild(o);
  });
  timerSubject.innerHTML='';
  subjects.forEach(s=>{
    const o=document.createElement('option');
    o.value=s.id; o.textContent=s.name;
    timerSubject.appendChild(o);
  });
}

// ===== æ‰‹å‹•è¨˜éŒ² =====
async function saveManual(){
  const subj = document.getElementById('manualSubject').value;
  const h = parseInt(document.getElementById('manualHour').value)||0;
  const m = parseInt(document.getElementById('manualMin').value)||0;
  const total = h*60+m;
  if(total<=0) return alert("1åˆ†ä»¥ä¸Šå…¥åŠ›ã—ã¦ãã ã•ã„");
  document.getElementById('manualHour').value='';
  document.getElementById('manualMin').value='';
  alert("è¨˜éŒ²ã—ã¾ã—ãŸ");
  await updateProfileDisplay(total);
  updateChart(subj,total);
}

// ===== ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°ï¼ˆç–‘ä¼¼APIï¼‰ =====
let profile={level:1,exp:0,totalMinutes:0,streak:0,weeklyTarget:20};
async function updateProfileDisplay(addMinutes=0){
  profile.totalMinutes += addMinutes;
  let need = profile.level*profile.level*100;
  let oldLevel=profile.level;
  profile.exp+=addMinutes;
  while(profile.exp>=need){
    profile.exp-=need;
    profile.level++;
    need=profile.level*profile.level*100;
    expFill.classList.add('exp-up');
    setTimeout(()=>expFill.classList.remove('exp-up'),300);
  }
  document.getElementById('level').textContent = profile.level;
  document.getElementById('streak').textContent = profile.streak;
  document.getElementById('weeklyRemain').textContent = Math.max(0,profile.weeklyTarget - profile.totalMinutes/60);
  expFill.style.width = Math.min(100,profile.exp/(profile.level*profile.level*100)*100)+'%';

  if(profile.totalMinutes/60>=100){
    bonusDiv.style.display='block';
    setTimeout(()=>bonusDiv.style.display='none',2000);
  }
}

// ===== ã‚¿ã‚¤ãƒãƒ¼ =====
function startTimer(){
  if(timerRunning) return;
  const selected = timerSubject.value;
  if(!selected) return alert("ç§‘ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„");
  currentSubject = selected;
  timerRunning = true;
  elapsedSeconds = 0;

  timerFull.style.display='flex';
  timerText.textContent='0:00';
  document.getElementById('start-btn').disabled=true;
  document.getElementById('stop-btn').disabled=false;
  document.getElementById('save-btn').style.display='none';
  document.getElementById('fullStartBtn').disabled=true;
  document.getElementById('fullStopBtn').disabled=false;
  document.getElementById('fullSaveBtn').style.display='none';

  timerInterval = setInterval(()=>{
    elapsedSeconds++;
    const min=Math.floor(elapsedSeconds/60);
    const sec=elapsedSeconds%60;
    timerText.textContent=`${min}:${sec.toString().padStart(2,'0')}`;
  },1000);
}

function stopTimer(){
  if(!timerRunning) return;
  clearInterval(timerInterval);
  timerRunning=false;

  document.getElementById('stop-btn').disabled=true;
  document.getElementById('save-btn').style.display='block';
  document.getElementById('fullStopBtn').disabled=true;
  document.getElementById('fullSaveBtn').style.display='block';

  document.getElementById('start-btn').disabled=false;
  document.getElementById('fullStartBtn').disabled=false;
}

async function saveTimer(){
  const minutes = Math.floor(elapsedSeconds/60);
  if(minutes<=0) return alert("1åˆ†ä»¥ä¸Šè¨ˆæ¸¬ã—ã¦ãã ã•ã„");
  alert(`ç§‘ç›®:${currentSubject} ã« ${minutes}åˆ† è¨˜éŒ²ã—ã¾ã—ãŸ`);
  elapsedSeconds=0;
  timerText.textContent='0:00';
  timerFull.style.display='none';
  document.getElementById('save-btn').style.display='none';
  document.getElementById('fullSaveBtn').style.display='none';

  await updateProfileDisplay(minutes);
  updateChart(currentSubject,minutes);
}

// ãƒœã‚¿ãƒ³è¨­å®š
document.getElementById('start-btn').addEventListener('click',startTimer);
document.getElementById('stop-btn').addEventListener('click',stopTimer);
document.getElementById('save-btn').addEventListener('click',saveTimer);
document.getElementById('fullStartBtn').addEventListener('click',startTimer);
document.getElementById('fullStopBtn').addEventListener('click',stopTimer);
document.getElementById('fullSaveBtn').addEventListener('click',saveTimer);

// ===== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ =====
function renderCalendar(){
  const calendar=document.getElementById('calendar');
  calendar.innerHTML='';
  for(let i=1;i<=30;i++){
    const d=document.createElement('div');
    d.className='day';
    d.textContent=i;
    calendar.appendChild(d);
  }
}

// ===== ã‚°ãƒ©ãƒ• =====
function initChart(){
  const ctx=document.getElementById('chart');
  chart=new Chart(ctx,{
    type:'bar',
    data:{labels:subjects.map(s=>s.name),datasets:[{label:'å‹‰å¼·æ™‚é–“',data:subjects.map(()=>0),backgroundColor:'#0f172a'}]},
    options:{responsive:true,animation:true}
  });
}

function updateChart(subj=null,addMinutes=0){
  if(!chart) initChart();
  if(subj){
    const idx=subjects.findIndex(s=>s.id===subj);
    if(idx>=0) chart.data.datasets[0].data[idx]+=addMinutes/60;
  }
  chart.update();
}
</script>
</body>
</html>
